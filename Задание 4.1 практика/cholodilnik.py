# Импорт Decimal для точных вычислений с десятичными числами
# Особенно важно для финансовых операций, где float может давать ошибки округления
from decimal import Decimal

# Импорт модуля для работы с датами и временем
import datetime

# Константа для формата даты: Год-Месяц-День (пример: 2023-12-31)
# Используется для конвертации строк в даты и обратно
DATE_FORMAT = '%Y-%m-%d'

# Основной словарь для хранения товаров
# Структура данных:
# - Ключ: название товара (строка)
# - Значение: список словарей, каждый из которых представляет партию товара
# Каждый словарь партии содержит:
#   - 'amount': количество товара (Decimal для точности)
#   - 'expiration_date': срок годности (datetime.date или None, если неограничен)
goods = {
    'Пельмени Универсальные': [
        {'amount': Decimal('0.5'), 'expiration_date': datetime.date(2023, 7, 15)},
        {'amount': Decimal('2'), 'expiration_date': datetime.date(2023, 8, 1)},
    ],
    'Вода': [
        {'amount': Decimal('1.5'), 'expiration_date': None}  # None = неограниченный срок
    ],
}


def add(title, amount, expiration_date=None):
    """
    Добавляет новую партию товара в базу данных.
    
    Параметры:
    - title: название товара (строка)
    - amount: количество (строка, число или Decimal)
    - expiration_date: срок годности (datetime.date или None)
    
    Примечание: Decimal(amount) преобразует входные данные в точный десятичный формат
    """
    # Проверяем, существует ли уже такой товар в базе
    if title in goods:
        # Если товар существует, добавляем новую партию в существующий список
        goods[title].append({'amount': Decimal(amount), 'expiration_date': expiration_date})
    else:
        # Если товара нет, создаем новую запись с одной партией
        goods[title] = [{'amount': Decimal(amount), 'expiration_date': expiration_date}]


def add_by_note(note):
    """
    Разбирает строку-заметку и добавляет товар в базу.
    
    Формат заметки: "количество название [дата_срока_годности]"
    Примеры:
    - "2.5 Яблоки 2023-12-31"
    - "1 Вода" (без срока годности)
    
    Параметры:
    - note: строка с описанием товара
    """
    # Разбиваем строку на части по пробелам
    parts = note.split()
    
    # Первый элемент - количество (преобразуем в Decimal)
    amount = Decimal(parts[0])
    
    # По умолчанию срок годности не указан
    expiration_date = None
    
    # Проверяем, достаточно ли частей для наличия даты (минимум 3: кол-во, название, дата)
    if len(parts) > 2:
        try:
            # Пытаемся преобразовать последний элемент в дату
            # strptime разбирает строку по заданному формату
            expiration_date = datetime.datetime.strptime(parts[-1], DATE_FORMAT).date()
            # Если успешно, то название товара - все части между количеством и датой
            name_parts = parts[1:-1]
        except ValueError:
            # Если преобразование не удалось, значит последний элемент - не дата
            # Вся строка после количества - название товара
            name_parts = parts[1:]
    else:
        # Если всего 2 части (количество и название), берем все после количества
        name_parts = parts[1:]
    
    # Собираем название товара из оставшихся частей
    title = ' '.join(name_parts)
    
    # Вызываем основную функцию добавления
    add(title, amount, expiration_date)


def find(keyword):
    """
    Находит товары, в названии которых содержится ключевое слово.
    
    Параметры:
    - keyword: ключевое слово для поиска (строка)
    
    Возвращает:
    - Список названий товаров, содержащих keyword (без учета регистра)
    """
    result = []
    
    # Проходим по всем товарам в базе
    for name in goods:
        # Поиск без учета регистра: приводим оба значения к нижнему регистру
        if keyword.lower() in name.lower():
            result.append(name)
    
    return result


def total_amount(product_name):
    """
    Вычисляет общее количество товара по названию.
    
    Параметры:
    - product_name: название или часть названия товара
    
    Возвращает:
    - Decimal: суммарное количество всех партий найденных товаров
    """
    total = Decimal('0')  # Инициализируем нулем в формате Decimal
    
    # Используем функцию find для поиска всех подходящих товаров
    for name in find(product_name):
        # Для каждого найденного товара суммируем все его партии
        for batch in goods[name]:
            total += batch['amount']
    
    return total


def get_all_details(product_name):
    """
    Формирует детальную информацию о всех найденных товарах.
    
    Параметры:
    - product_name: название или часть названия товара
    
    Возвращает:
    - Список строк с информацией о каждом найденном товаре
    """
    details = []
    
    # Ищем все товары, соответствующие запросу
    for name in find(product_name):
        # Вычисляем общее количество для этого товара
        # Генератор списка суммирует все amount в партиях
        qty = sum(batch['amount'] for batch in goods[name])
        
        # Создаем список сроков годности (только для партий, где он указан)
        # .strftime() преобразует дату в строку по заданному формату
        date_list = [
            batch['expiration_date'].strftime(DATE_FORMAT) 
            for batch in goods[name] 
            if batch['expiration_date']  # Проверяем, что срок не None
        ]
        
        # Формируем строку со сроками
        # Если есть сроки - объединяем через запятую, иначе пишем "неограниченно"
        dates_str = ', '.join(date_list) if date_list else 'неограниченно'
        
        # Формируем итоговую строку информации о товаре
        details.append(f"{name}: {qty} шт., сроки: {dates_str}")
    
    return details


if __name__ == "__main__":
    """
    Основной цикл программы с интерфейсом командной строки.
    Позволяет пользователю взаимодействовать с программой.
    """
    # Бесконечный цикл для постоянной работы программы
    while True:
        # Запрашиваем команду у пользователя
        command = input("Введите команду ('поиск', 'добавить', 'выход'): ").strip().lower()
        
        # Команда выхода из программы
        if command == 'выход':
            break
        
        # Команда поиска товаров
        elif command == 'поиск':
            keyword = input("Введите название продукта для поиска: ")
            results = find(keyword)
            
            if results:
                # Получаем детальную информацию о найденных товарах
                details_list = get_all_details(keyword)
                for detail in details_list:
                    print(detail)  # Выводим информацию о каждом товаре
            else:
                print("Продукты не найдены.")
        
        # Команда добавления нового товара
        elif command == 'добавить':
            note = input("Введите описание продукта (например: '3.0 Пельмени Универсальные 2023-09-01'): ")
            add_by_note(note)
            print("Продукт добавлен.")
        
        # Обработка неизвестной команды
        else:
            print("Неизвестная команда. Попробуйте снова.")
